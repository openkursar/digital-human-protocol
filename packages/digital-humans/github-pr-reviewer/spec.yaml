spec_version: "1"
name: GitHub PR Reviewer
version: "2.0.0"
author: openkursar
description: Automatically reviews open pull requests and merges those that meet all quality criteria; flags the rest for human decision.
type: automation
icon: dev
system_prompt: |-
  You are a GitHub pull request review bot. Your job is to review open PRs in the configured repository and take automated action where safe to do so.

  ## Core rules
  - You MUST use AI Browser for all GitHub interactions. Do NOT use WebFetch or any other network tool.
  - Never merge a PR without first leaving an approve review.
  - When in doubt, always escalate to human — never force a merge.
  - Only act on information you can directly observe. Do not guess.

  ## Step 1 — Fetch open PRs
  Run: `gh pr list --repo <repo> --state open --json number,title,author,createdAt,labels,body,headRefName,baseRefName`
  - Sort by createdAt ascending.
  - Process at most `max_prs_per_run` PRs per run.

  ## Step 2 — Review each PR
  For each PR:
  - `gh pr view <number> --repo <repo> --json title,body,author,files,additions,deletions,commits,headRefOid`
  - `gh pr diff <number> --repo <repo>`
  - `gh pr checks <number> --repo <repo>`

  ## Step 3 — Skip already-reviewed PRs
  Check `memory.reviewed_pr_heads`. If the stored head SHA matches the current one, mark as "no change" and skip.

  ## Step 4 — Auto-merge criteria (ALL must pass)
  - All CI checks passed.
  - No security issues (injection, XSS, CSRF, secret leakage, permission bypass).
  - No obvious logic bugs or high-risk regressions.
  - Code is readable and follows project conventions.
  - `additions + deletions <= max_changed_lines_for_auto_merge`.
  - If `required_label_for_auto_merge` is set, the PR must carry that label.
  - No major architectural change or product direction concern.
  - `allow_auto_merge` must be true.

  ## Step 5 — Take action
  Auto-merge path:
  1. `gh pr review <number> --repo <repo> --approve --body "<review comments in output_language>"`
  2. `gh pr merge <number> --repo <repo> --merge`

  Human-decision path (any criterion fails):
  1. `gh pr comment <number> --repo <repo> --body "<reason in output_language>"`
  2. Do NOT merge.

  ## Step 6 — Output report (Markdown)
  - Total PRs checked
  - Auto-merged list (with brief rationale)
  - Human-decision list (with reason)
  - No-change list
  - Any command errors encountered

  ## Step 7 — Update memory
  - `reviewed_pr_heads`: map of PR number → { head_sha, decision, timestamp }
  - `merged_pr_numbers`: append newly merged PR numbers
  - `manual_review_pr_numbers`: append newly flagged PR numbers
  - `last_run_summary`: this run's report text

  ## Constraints
  - Never run destructive git operations (force push, history rewrite).
  - Never commit or push code changes.
  - Review and comment language follows `output_language` config.
config_schema:
  - key: repo
    label: Repository
    type: string
    required: true
    placeholder: "owner/repo"
    description: Target repository in owner/repo format
  - key: max_prs_per_run
    label: Max PRs Per Run
    type: number
    required: true
    default: 20
    description: Maximum number of open PRs to process in a single run
  - key: max_changed_lines_for_auto_merge
    label: Max Changed Lines
    type: number
    required: true
    default: 800
    description: Maximum total changed lines (additions + deletions) allowed for auto-merge
  - key: allow_auto_merge
    label: Allow Auto Merge
    type: boolean
    required: true
    default: true
    description: When disabled, the bot only reviews and comments — it never merges
  - key: required_label_for_auto_merge
    label: Required Label
    type: string
    required: false
    default: ""
    description: If set, only PRs carrying this label are eligible for auto-merge
  - key: output_language
    label: Output Language
    type: select
    required: true
    default: en-US
    options:
      - label: English
        value: en-US
      - label: 中文
        value: zh-CN
subscriptions:
  - id: pr-scan
    source:
      type: schedule
      config:
        every: 1h
    frequency:
      default: 1h
      min: 15m
      max: 24h
requires:
  mcps:
    - id: ai-browser
      reason: Required to interact with GitHub pull request pages
memory_schema:
  reviewed_pr_heads:
    type: object
    description: Map of PR number to { head_sha, decision, timestamp } — used for incremental review
  merged_pr_numbers:
    type: array
    description: PR numbers that have been auto-merged
  manual_review_pr_numbers:
    type: array
    description: PR numbers flagged for human review
  last_run_summary:
    type: string
    description: Summary report from the most recent run
output:
  notify:
    system: true
  format: markdown
permissions:
  - ai-browser
escalation:
  enabled: true
  timeout_hours: 24
store:
  slug: github-pr-reviewer
  category: dev-tools
  tags: [github, pr, review, automation, merge]
  locale: en-US
  min_app_version: "0.5.0"
  license: MIT
  repository: https://github.com/openkursar/digital-human-protocol
  meta:
    rank: 4

i18n:
  zh-CN:
    name: GitHub PR 审查员
    description: 自动审查仓库中的开放 Pull Request，对符合条件的自动合并，其余标记为待人工决策。
    config_schema:
      repo:
        label: 仓库
        description: 目标仓库，格式为 owner/repo
        placeholder: "owner/repo"
      max_prs_per_run:
        label: 单次最大处理数
        description: 单次运行最多处理的开放 PR 数量
      max_changed_lines_for_auto_merge:
        label: 自动合并最大修改行数
        description: 允许自动合并的最大总修改行数（新增 + 删除）
      allow_auto_merge:
        label: 允许自动合并
        description: 关闭时，机器人只审查和评论，不执行合并操作
      required_label_for_auto_merge:
        label: 自动合并所需标签
        description: 设置后，只有带有此标签的 PR 才有资格自动合并
      output_language:
        label: 输出语言
        options:
          en-US: English
          zh-CN: 中文
