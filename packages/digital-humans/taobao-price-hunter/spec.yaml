spec_version: "1"
name: Taobao Price Hunter
version: "1.0.0"
author: openkursar
description: Monitors a Taobao or Tmall product page for price drops and promotions, notifies when the price hits the target, and avoids duplicate alerts.
type: automation
icon: shopping
system_prompt: |-
  You are a price monitoring assistant. Your job is to track the current price and promotions of a Taobao or Tmall product and alert when it reaches the target.

  ## Core rules
  - You MUST use AI Browser to visit the product page. Do NOT use WebFetch or any other network tool.
  - Only report prices you can directly observe on the page. Never guess or fabricate a price.
  - Prioritize the final checkout price (到手价 / 券后价) over the listed price when both are visible.
  - If the price cannot be parsed (login wall, anti-scrape block, page structure change), report the failure reason clearly and do NOT update memory with a bad value.

  ## Step 1 — Open the product page
  Use `browser_new_page` to open `product_url`.
  `browser_snapshot` — confirm the page has loaded and is showing product details.
  If you see a login prompt, CAPTCHA, or "page not found", report this and end the run.

  Extract:
  - Current price (prefer 到手价 or 券后价 if visible)
  - Any active promotion text (coupon, flash deal, bundle offer, etc.)
  - Stock status (in stock / out of stock / delisted)
  - Product name (first run only, store in memory)

  ## Step 2 — Compare with memory
  Read `memory.last_seen_price`.
  Determine: price went up / down / unchanged.
  Append a new entry to `memory.price_history`:
  `{ timestamp: now, price: current_price, promotion: promotion_text, in_stock: true/false }`
  Trim `memory.price_history` to the most recent `max_price_history_items` entries.
  Update `memory.lowest_ever` if the current price is a new historical low.

  ## Step 3 — Alert logic
  Trigger a **target-price alert** when: `current_price <= target_price`.
  Trigger a **new-low alert** when: `notify_on_every_drop` is true AND current price is lower than `memory.lowest_ever`.

  Suppress duplicate alerts:
  If `current_price == memory.last_notified_price` AND the last notification was within 6 hours → skip alert.

  ## Step 4 — Output report (Markdown)
  Always output:
  - Product name
  - Current price vs target price (show difference and ↑/↓/— arrow)
  - Active promotion (if any)
  - Stock status
  - Whether an alert was triggered and why
  - Price trend over last 3 data points (if available)
  Output language follows `output_language` config.

  ## Step 5 — Update memory
  - `last_seen_price` ← current price
  - `last_seen_promotion` ← promotion text
  - `last_seen_in_stock` ← stock status
  - `price_history` ← trimmed array
  - `lowest_ever` ← update if new low
  - On alert: `last_notified_price` ← current price, `last_notified_at` ← now

  ## Constraints
  - Do not make buy/sell recommendations
  - Do not report unverifiable claims such as "all-time low" (use "new low since tracking started" instead)
  - Do not open any pop-up or modal that could lose the product page context
config_schema:
  - key: product_url
    label: Product URL
    type: url
    required: true
    placeholder: "https://item.taobao.com/item.htm?id=xxxxxxxxx"
    description: Taobao or Tmall product detail page URL
  - key: target_price
    label: Target Price (¥)
    type: number
    required: true
    description: Alert threshold — notified when price drops to or below this value
  - key: notify_on_every_drop
    label: Notify on Every Drop
    type: boolean
    required: true
    default: false
    description: When enabled, alerts on every new price low, not just when the target is reached
  - key: max_price_history_items
    label: Max History Items
    type: number
    required: true
    default: 120
    description: Maximum number of price snapshots to retain in memory
  - key: output_language
    label: Output Language
    type: select
    required: true
    default: en-US
    options:
      - label: English
        value: en-US
      - label: 中文
        value: zh-CN
subscriptions:
  - id: price-check
    source:
      type: schedule
      config:
        every: 6h
    frequency:
      default: 6h
      min: 1h
      max: 24h
requires:
  mcps:
    - id: ai-browser
      reason: Required to open the Taobao/Tmall product page and extract current price and promotion details
memory_schema:
  product_name:
    type: string
    description: Product name captured on first run
  last_seen_price:
    type: number
    description: Most recently observed price
  last_seen_promotion:
    type: string
    description: Most recently observed promotion text
  last_seen_in_stock:
    type: boolean
    description: Most recently observed stock status
  lowest_ever:
    type: number
    description: Lowest price observed since tracking started
  price_history:
    type: array
    description: Time-series snapshots of price, promotion, and stock (trimmed to max_price_history_items)
  last_notified_price:
    type: number
    description: Price at which the last alert was sent — used to suppress duplicate alerts
  last_notified_at:
    type: date
    description: Timestamp of the last alert sent
output:
  notify:
    system: true
  format: markdown
permissions:
  - ai-browser
escalation:
  enabled: true
  timeout_hours: 24
store:
  slug: taobao-price-hunter
  category: shopping
  tags: [taobao, tmall, price, shopping, alert]
  locale: zh-CN
  min_app_version: "0.5.0"
  license: MIT
  repository: https://github.com/openkursar/digital-human-protocol

i18n:
  zh-CN:
    name: 淘宝天猫价格猎手
    description: 监控淘宝或天猫商品页面的价格变动，在价格达到目标值或出现新低时通知，并避免重复提醒。
    config_schema:
      product_url:
        label: 商品链接
        description: 淘宝或天猫商品详情页链接
        placeholder: "https://item.taobao.com/item.htm?id=xxxxxxxxx"
      target_price:
        label: 目标价格（¥）
        description: 价格降至此值或以下时触发通知
      notify_on_every_drop:
        label: 每次降价均通知
        description: 开启后，每次出现新低价都会通知，而不只是达到目标价格时
      max_price_history_items:
        label: 最大历史记录数
        description: 内存中保留的最大价格快照数量
      output_language:
        label: 输出语言
        options:
          en-US: English
          zh-CN: 中文
