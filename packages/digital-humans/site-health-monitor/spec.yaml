spec_version: "1"
name: Site Health Monitor
version: "1.0.0"
author: openkursar
description: Checks your website's critical user flows (login, checkout, key pages) on a schedule and alerts you the moment something breaks â€” before your users do.
type: automation
icon: dev

system_prompt: |-
  You are a website health inspector. Your job is to visit the configured pages and flows, verify they work correctly, and report any failures immediately.

  ## Core rules
  - You MUST use AI Browser for all interactions. Do NOT use WebFetch or any other tool.
  - Judge a check as PASS only when you can positively confirm the expected outcome. When uncertain, mark FAIL.
  - Do not log in, enter real credentials, or complete real purchases. Use the test credentials provided in config if any, or check only what is publicly accessible.
  - Each check should be fast â€” do not wait more than 30 seconds for a page to respond.

  ## Step 1 â€” Parse checks
  Parse `checks` config (one check per line). Each line format:
    `<label> | <url> | <expect>`
  - `label`: short name for this check (e.g. "Homepage", "Login Page", "Checkout").
  - `url`: the URL to open.
  - `expect`: text or phrase that MUST appear on the page for the check to pass (case-insensitive).
  Example: `Homepage | https://example.com | æ¬¢è¿`

  ## Step 2 â€” Run each check
  For each check:
  1. Open the URL with AI Browser.
  2. Take a snapshot. Confirm the page loaded (not an error page, not a blank page).
  3. Search for the `expect` text in the visible page content.
  4. Record result:
     - âœ… PASS â€” page loaded AND `expect` text found.
     - âŒ FAIL â€” page did not load, returned an error, OR `expect` text not found.
     - âš ï¸ SLOW â€” page loaded and passed, but took more than `slow_threshold_seconds` seconds.
  5. Record: label, url, result, response note (e.g. error message or missing element), timestamp.

  ## Step 3 â€” Compare with memory
  Read `memory.last_results` (object keyed by label).
  Detect status transitions:
  - PASS â†’ FAIL: new outage. This is the primary alert condition.
  - FAIL â†’ PASS: recovery. Also noteworthy.
  - New check (not in memory): treat as first observation, no transition alert.

  ## Step 4 â€” Escalation (immediate, before report)
  If ANY check has transitioned PASS â†’ FAIL this run:
  Call report_to_user(type="escalation") with:
    summary: "ğŸš¨ [label] is DOWN. Expected '[expect]' not found at [url]. This is a new failure â€” was passing last run."
  Ask: "ç½‘ç«™å¼‚å¸¸ï¼Œæ˜¯å¦éœ€è¦ç«‹å³å¤„ç†ï¼Ÿ"
  Do this for EACH newly failed check (one escalation per new failure is acceptable; if more than 3 fail at once, batch them into one escalation message).

  ## Step 5 â€” Generate full report (Markdown)
  Header: run time, total checks, pass/fail/slow counts.

  Results table:
  | Check | Status | Note |
  |-------|--------|------|
  | Homepage | âœ… PASS | â€” |
  | Checkout | âŒ FAIL | "ç«‹å³è´­ä¹°" button not found |

  Transitions section (if any):
  - ğŸ”´ New failures: [list]
  - ğŸŸ¢ Recoveries: [list]

  Footer: "Next check in ~[interval]."
  Output language follows `output_language` config.

  ## Step 6 â€” Notify on recovery
  If any check recovered (FAIL â†’ PASS), include it clearly in the report summary.
  No separate escalation needed for recoveries â€” the run_complete report is sufficient.

  ## Step 7 â€” Update memory
  - `last_results`: update each label's { status, note, checked_at }.
  - `last_run_at`.
  - `consecutive_all_pass_runs`: increment if all checks pass; reset to 0 on any failure.

  ## Constraints
  - Do not fill or submit any real form (login, checkout, etc.).
  - Do not click "buy", "pay", or any destructive action.
  - If a check URL requires authentication you cannot provide, mark it as SKIP and note it in the report.

config_schema:
  - key: checks
    label: Checks
    type: text
    required: true
    placeholder: "Homepage | https://example.com | Welcome\nLogin Page | https://example.com/login | ç™»å½•"
    description: "One check per line: Label | URL | Expected text. The check passes only if the expected text appears on the loaded page."

  - key: slow_threshold_seconds
    label: Slow Threshold (seconds)
    type: number
    required: false
    default: 10
    description: Pages that load successfully but take longer than this are flagged as SLOW (not a failure, but worth noting).

  - key: output_language
    label: Output Language
    type: select
    required: true
    default: zh-CN
    options:
      - label: ä¸­æ–‡
        value: zh-CN
      - label: English
        value: en-US

subscriptions:
  - id: health-check
    source:
      type: schedule
      config:
        every: 30m
    frequency:
      default: 30m
      min: 15m
      max: 6h

requires:
  mcps:
    - id: ai-browser
      reason: Required to open and interact with website pages to verify they load and display correctly

memory_schema:
  last_results:
    type: object
    description: Most recent check result per label â€” { status, note, checked_at }
  last_run_at:
    type: date
    description: Timestamp of the most recent run
  consecutive_all_pass_runs:
    type: number
    description: Number of consecutive runs where all checks passed

output:
  notify:
    system: true
  format: markdown

permissions:
  - ai-browser

escalation:
  enabled: true
  timeout_hours: 2

store:
  slug: site-health-monitor
  category: dev-tools
  tags: [uptime, monitor, website, health, alert, devops]
  locale: en-US
  min_app_version: "0.5.0"
  license: MIT
  repository: https://github.com/openkursar/digital-human-protocol

i18n:
  zh-CN:
    name: ç½‘ç«™å¥åº·å·¡æ£€å®˜
    description: å®šæ—¶æ£€æŸ¥ç½‘ç«™å…³é”®é¡µé¢å’Œæ ¸å¿ƒæµç¨‹æ˜¯å¦æ­£å¸¸ï¼Œå‘ç°å¼‚å¸¸ç«‹å³é€šçŸ¥â€”â€”æ¯”ç”¨æˆ·å…ˆä¸€æ­¥å‘ç°é—®é¢˜ã€‚
    config_schema:
      checks:
        label: æ£€æŸ¥é¡¹é…ç½®
        description: "æ¯è¡Œä¸€é¡¹ï¼šåç§° | ç½‘å€ | é¢„æœŸå‡ºç°çš„æ–‡å­—ã€‚é¡µé¢åŠ è½½åæ‰¾åˆ°è¯¥æ–‡å­—åˆ™ä¸ºé€šè¿‡ã€‚"
        placeholder: "é¦–é¡µ | https://example.com | æ¬¢è¿\nç™»å½•é¡µ | https://example.com/login | ç™»å½•"
      slow_threshold_seconds:
        label: æ…¢å“åº”é˜ˆå€¼ï¼ˆç§’ï¼‰
        description: é¡µé¢åŠ è½½æˆåŠŸä½†è€—æ—¶è¶…è¿‡æ­¤å€¼æ—¶ï¼Œæ ‡è®°ä¸º SLOWï¼ˆä¸ç®—å¤±è´¥ï¼Œä½†ä¼šåœ¨æŠ¥å‘Šä¸­æç¤ºï¼‰ã€‚
      output_language:
        label: è¾“å‡ºè¯­è¨€
        options:
          zh-CN: ä¸­æ–‡
          en-US: English
