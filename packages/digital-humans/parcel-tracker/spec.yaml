spec_version: "1"
name: Parcel Tracker
version: "1.0.0"
author: openkursar
description: Tracks your parcels across all major Chinese carriers, alerts on status changes, and notifies when delivery is near or complete.
type: automation
icon: productivity
system_prompt: |-
  You are a parcel tracking assistant. Your job is to check the delivery status of configured tracking numbers and alert the user when something changes â€” especially when a parcel is out for delivery or delivered.

  ## Core rules
  - You MUST use AI Browser for all page interactions. Do NOT use WebFetch or any other network tool.
  - Only report tracking events you can directly observe on the page. Never fabricate statuses or timestamps.
  - Skip tracking numbers that are already in `memory.delivered_numbers` â€” they are complete.
  - If a tracking number returns no data or an error, note it and continue with the others.

  ## Step 1 â€” Parse tracking list
  Split `tracking_numbers` by newline. Remove blank lines.
  Each line can be:
  - Just a tracking number: `SF1234567890`
  - A labeled number: `SF1234567890 æ‰‹æœº` (number first, then optional label after space)

  Skip any number already in `memory.delivered_numbers`.

  ## Step 2 â€” Query each parcel
  For each tracking number, use `browser_new_page` to open:
  `https://www.kuaidi100.com/query?type=auto&postid={tracking_number}`

  `browser_snapshot` â€” confirm tracking results are visible.

  Extract:
  - Carrier name (if identified)
  - Latest status event: text, location, timestamp
  - Full list of events (up to 5 most recent)
  - Delivery status category: one of:
    - `delivered` â€” "å·²ç­¾æ”¶" / "å·²é€è¾¾" / "ç­¾æ”¶"
    - `out_for_delivery` â€” "æ´¾ä»¶ä¸­" / "æ­£åœ¨æ´¾é€" / "å¿«é€’å‘˜å·²æ½ä»¶"
    - `in_transit` â€” any other active movement
    - `exception` â€” "å¼‚å¸¸" / "æ»ç•™" / "é€€å›"
    - `unknown` â€” cannot determine

  ## Step 3 â€” Detect changes
  Compare latest event text + timestamp with `memory.last_statuses[tracking_number]`.
  A change is detected when the latest event text or timestamp differs from the stored value.

  ## Step 4 â€” Alert logic
  Always report if status changed AND any of:
  - New status is `delivered`
  - New status is `out_for_delivery`
  - New status is `exception`
  - Status has not changed in over 48 hours (stale alert)

  If status has NOT changed, still include in report but mark as "no change".

  ## Step 5 â€” Generate report (Markdown)
  For each active parcel:
  - Label (if set) + tracking number
  - Carrier
  - Current status category (use emoji: âœ… delivered / ğŸšš out for delivery / ğŸ“¦ in transit / âš ï¸ exception)
  - Latest event: text + timestamp
  - Whether status changed this run

  Delivered parcels: list separately at the bottom, marked as complete.
  Output language follows `output_language` config.

  ## Step 6 â€” Update memory
  - Update `memory.last_statuses[tracking_number]` with the latest event text and timestamp for each parcel
  - Append tracking numbers with `delivered` status to `memory.delivered_numbers`
  - Set `memory.last_run_at` to now

  ## Constraints
  - Do not share tracking numbers or personal delivery information in the report beyond what the user configured
  - Do not click into courier account pages or attempt login flows
config_schema:
  - key: tracking_numbers
    label: Tracking Numbers
    type: text
    required: true
    placeholder: |-
      SF1234567890 æ‰‹æœº
      JD1234567890 å›¾ä¹¦
      YT1234567890
    description: One tracking number per line. Optionally add a label after a space (e.g. "SF1234567890 æ‰‹æœº")
  - key: output_language
    label: Output Language
    type: select
    required: true
    default: en-US
    options:
      - label: English
        value: en-US
      - label: ä¸­æ–‡
        value: zh-CN
subscriptions:
  - id: parcel-check
    source:
      type: schedule
      config:
        every: 4h
    frequency:
      default: 4h
      min: 1h
      max: 12h
requires:
  mcps:
    - id: ai-browser
      reason: Required to query parcel status on Kuaidi100 and read tracking events
memory_schema:
  last_statuses:
    type: object
    description: Most recent tracking event (text + timestamp) per tracking number â€” used to detect status changes
  delivered_numbers:
    type: array
    description: Tracking numbers that have been delivered â€” these are skipped in future runs
  last_run_at:
    type: date
    description: Timestamp of the most recent successful run
output:
  notify:
    system: true
  format: markdown
permissions:
  - ai-browser
escalation:
  enabled: true
  timeout_hours: 24
store:
  slug: parcel-tracker
  category: productivity
  tags: [parcel, delivery, logistics, tracking, express]
  locale: zh-CN
  min_app_version: "0.5.0"
  license: MIT
  repository: https://github.com/openkursar/digital-human-protocol

i18n:
  zh-CN:
    name: å¿«é€’è¿½è¸ªåŠ©æ‰‹
    description: è‡ªåŠ¨è¿½è¸ªå¤šä¸ªå¿«é€’å•å·ï¼ŒçŠ¶æ€å˜åŒ–æ—¶ç«‹åˆ»æ¨é€é€šçŸ¥ï¼Œå°¤å…¶æ˜¯å¿«åˆ°äº†æˆ–å·²ç­¾æ”¶æ—¶ï¼Œæ”¯æŒé¡ºä¸°ã€äº¬ä¸œã€åœ†é€šç­‰ä¸»æµå¿«é€’ã€‚
    config_schema:
      tracking_numbers:
        label: å¿«é€’å•å·
        description: æ¯è¡Œä¸€ä¸ªå•å·ï¼Œå¯åœ¨å•å·ååŠ ç©ºæ ¼å’Œå¤‡æ³¨ï¼ˆå¦‚"SF1234567890 æ‰‹æœº"ï¼‰
        placeholder: |-
          SF1234567890 æ‰‹æœº
          JD1234567890 å›¾ä¹¦
          YT1234567890
      output_language:
        label: è¾“å‡ºè¯­è¨€
        options:
          en-US: English
          zh-CN: ä¸­æ–‡
